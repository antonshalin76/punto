/**
 * @file ngram_data.hpp
 * @brief Таблицы частотности биграмм для EN и RU языков
 *
 * Используются для вероятностного анализа принадлежности слова
 * к определённому языку. Значения весов нормализованы 0-255.
 *
 * Источники данных:
 * - Частотный словарь русского языка (Ляшевская, Шаров)
 * - English letter frequency (Cornell University)
 */

#pragma once

#include <array>
#include <cstdint>

#include "punto/asm_utils.hpp"

namespace punto {

// ===========================================================================
// Таблица биграмм английского языка (топ-100+)
// ===========================================================================

// clang-format off
inline constexpr std::array<BigramEntry, 128> kEnBigrams = {{
    // Самые частые биграммы английского языка
    {'t', 'h', 255}, // the
    {'h', 'e', 250}, // he, the
    {'i', 'n', 245}, // in
    {'e', 'r', 240}, // er
    {'a', 'n', 235}, // an
    {'r', 'e', 230}, // re
    {'o', 'n', 225}, // on
    {'e', 'n', 220}, // en
    {'a', 't', 215}, // at
    {'e', 's', 210}, // es
    {'e', 'd', 205}, // ed
    {'t', 'o', 200}, // to
    {'i', 't', 195}, // it
    {'o', 'u', 190}, // ou
    {'e', 'a', 185}, // ea
    {'h', 'i', 180}, // hi
    {'i', 's', 175}, // is
    {'o', 'r', 170}, // or
    {'t', 'i', 165}, // ti
    {'a', 's', 160}, // as
    {'t', 'e', 155}, // te
    {'s', 't', 150}, // st
    {'a', 'r', 145}, // ar
    {'n', 'd', 140}, // nd
    {'n', 'g', 135}, // ng
    {'a', 'l', 130}, // al
    {'i', 'c', 125}, // ic
    {'n', 't', 120}, // nt
    {'l', 'l', 115}, // ll
    {'l', 'e', 110}, // le
    {'o', 'f', 105}, // of
    {'s', 'e', 100}, // se
    {'r', 'o', 95},  // ro
    {'v', 'e', 90},  // ve
    {'c', 'o', 85},  // co
    {'m', 'e', 80},  // me
    {'d', 'e', 75},  // de
    {'h', 'a', 70},  // ha
    {'n', 'e', 65},  // ne
    {'r', 'a', 60},  // ra
    {'c', 'e', 55},  // ce
    {'l', 'i', 50},  // li
    {'r', 'i', 45},  // ri
    {'c', 'h', 40},  // ch
    {'w', 'a', 38},  // wa
    {'w', 'h', 36},  // wh
    {'o', 'w', 34},  // ow
    {'s', 'h', 32},  // sh
    {'c', 'a', 30},  // ca
    {'m', 'a', 28},  // ma
    {'c', 't', 26},  // ct
    {'u', 's', 24},  // us
    {'g', 'e', 22},  // ge
    {'a', 'i', 20},  // ai
    {'a', 'm', 18},  // am
    {'u', 't', 16},  // ut
    {'l', 'a', 14},  // la
    {'w', 'o', 12},  // wo
    {'e', 'l', 10},  // el
    {'b', 'e', 8},   // be
    {'y', 'o', 6},   // yo
    {'f', 'o', 4},   // fo
    {'u', 'r', 3},   // ur
    {'p', 'e', 2},   // pe

    // Дополнительные частые биграммы
    {'h', 'o', 50},
    {'l', 'o', 48},
    {'n', 'o', 46},
    {'s', 'o', 44},
    {'d', 'o', 42},
    {'g', 'o', 40},
    {'i', 'e', 38},
    {'u', 'n', 36},
    {'p', 'r', 34},
    {'f', 'r', 32},
    {'t', 'r', 30},
    {'w', 'e', 28},
    {'b', 'u', 26},
    {'p', 'a', 24},
    {'k', 'e', 22},
    {'p', 'o', 20},
    {'o', 'p', 18},
    {'i', 'o', 16},
    {'u', 'l', 14},
    {'s', 'a', 12},
    {'s', 'i', 10},
    {'e', 'w', 8},
    {'r', 's', 6},
    {'o', 't', 4},
    {'i', 'g', 3},
    {'i', 'l', 2},

    // Частые начала слов
    {'t', 'a', 35},
    {'p', 'l', 30},
    {'b', 'l', 25},
    {'c', 'l', 22},
    {'g', 'r', 20},
    {'s', 'p', 18},
    {'s', 'c', 16},
    {'s', 'w', 14},
    {'s', 'n', 12},
    {'s', 'l', 10},
    {'s', 'm', 8},
    {'b', 'r', 6},
    {'d', 'r', 4},
    {'f', 'l', 3},
    {'g', 'l', 2},
    {'p', 'h', 1},

    // Частые окончания
    {'l', 'y', 45},
    {'r', 'y', 40},
    {'n', 's', 35},
    {'t', 's', 30},
    {'i', 'a', 25},
    {'u', 'e', 20},
    {'a', 'y', 15},
    {'e', 'y', 10},
    {'o', 'd', 8},
    {'i', 'd', 6},
    {'a', 'd', 4},
    {'i', 'f', 2},
    {'o', 'e', 1},
    {'e', 't', 1},
    {'u', 'p', 1},
    {'o', 's', 1},
    {'i', 'p', 1},
    {'a', 'b', 1},
}};

// ===========================================================================
// Таблица биграмм русского языка (топ-100+)
// ===========================================================================

inline constexpr std::array<BigramEntry, 128> kRuBigrams = {{
    // Самые частые биграммы русского языка (в латинской транскрипции QWERTY)
    // Примечание: используем латинские эквиваленты для скан-кодов
    // ст -> cn, то -> nj, на -> yf, ен -> ty, ни -> yb, и т.д.

    {'c', 'n', 255}, // ст
    {'n', 'j', 250}, // то
    {'y', 'f', 245}, // на
    {'t', 'y', 240}, // ен
    {'y', 'b', 235}, // ни
    {'j', 'd', 230}, // ов
    {'g', 'h', 225}, // пр
    {'j', ',', 220}, // об
    {'k', 'f', 215}, // ла
    {'t', 'h', 210}, // ер
    {'h', 'f', 205}, // ра
    {'f', 'k', 200}, // ал
    {'j', 'h', 195}, // ор
    {'b', '.', 190}, // ию
    {'h', 'j', 185}, // ро
    {'j', 'y', 180}, // он
    {'y', 't', 175}, // не
    {'g', 'j', 170}, // по
    {'y', 'j', 165}, // но
    {'d', 'f', 160}, // ва
    {'u', 'j', 155}, // го
    {'t', 'k', 150}, // ел
    {'f', 'y', 145}, // ан
    {'b', 'n', 140}, // ит
    {'r', 'j', 135}, // ко
    {'f', 'n', 130}, // ат
    {'h', 't', 125}, // ре
    {'k', 't', 120}, // ле
    {'t', 'v', 115}, // ем
    {'k', 'b', 110}, // ли
    {'n', 'f', 105}, // та
    {'j', 'c', 100}, // ос
    {'d', 'j', 95},  // во
    {'t', 'c', 90},  // ес
    {'y', 's', 85},  // ны
    {'j', 'l', 80},  // од
    {'c', 'r', 75},  // ск
    {'l', 'f', 70},  // да
    {'b', 'b', 65},  // ии (в окончаниях)
    {'v', 't', 60},  // ме
    {'t', 'l', 55},  // ед
    {'c', 'f', 50},  // са
    {'l', 't', 45},  // де
    {'y', 'y', 40},  // нн
    {'b', 'z', 35},  // ип
    {'e', 't', 30},  // ке
    {'f', 'b', 25},  // аи
    {'j', 'k', 20},  // ол
    {'h', 'b', 15},  // ри
    {'d', 't', 10},  // ве
    {'j', 'q', 8},   // ой
    {'t', 'q', 6},   // ей
    {'j', 'n', 4},   // от
    {'l', 'j', 3},   // до
    {'r', 'f', 2},   // ка

    // Дополнительные частые биграммы
    {'b', 'y', 50},  // ин
    {'c', 'j', 48},  // со
    {'g', 'f', 46},  // па
    {'k', 'j', 44},  // ло
    {'d', 'b', 42},  // ви
    {'x', 'f', 40},  // ча
    {'d', 's', 38},  // вы
    {'h', 's', 36},  // ры
    {'j', 'u', 34},  // ог
    {'y', 'b', 32},  // ни
    {'n', 't', 30},  // те
    {'c', 'b', 28},  // си
    {'n', 'b', 26},  // ти
    {'b', 'r', 24},  // ик
    {'c', 't', 22},  // се
    {'g', 't', 20},  // пе
    {'v', 'b', 18},  // ми
    {',', 's', 16},  // бы
    {'e', 'f', 14},  // ка (через ке)
    {'e', 'b', 12},  // ки
    {'l', 'b', 10},  // ди
    {'f', 'd', 8},   // ав
    {'z', 'j', 6},   // зо
    {'j', 'e', 4},   // ок

    // Частые начала слов
    {'g', 'h', 55},  // пр
    {'c', 'd', 50},  // св
    {'j', ',', 45},  // об
    {'g', 'j', 40},  // по
    {'d', 'c', 35},  // вс
    {'d', 's', 30},  // вы
    {'g', 't', 25},  // пе
    {'c', 'g', 20},  // сп
    {'c', 'n', 15},  // ст
    {'g', 'k', 10},  // пл
    {'r', 'h', 8},   // кр
    {'n', 'h', 6},   // тр
    {'c', 'k', 4},   // сл
    {'c', 'v', 3},   // см
    {'c', 'c', 2},   // сс

    // Частые окончания
    {'n', 'm', 55},  // ть
    {'c', 'n', 50},  // ст (внутри слова)
    {'b', 'b', 45},  // ии
    {'.', '.', 40},  // юю (редко)
    {'s', 'q', 35},  // ый
    {'b', 'q', 30},  // ий
    {'s', 'v', 25},  // ым
    {'b', 'v', 20},  // им
    {'c', 'z', 15},  // сь
    {'n', 'z', 12},  // ться -> тся(tz) +
    {'j', 'v', 10},  // ом
    {'t', 'n', 8},   // ет
    {'f', 'v', 6},   // ам
    {'j', 'q', 5},   // ой
    {'t', 'q', 4},   // ей
    {'b', 'k', 3},   // ил
    {'s', 'k', 2},   // ыл
}};
// clang-format on

// ===========================================================================
// Функции поиска
// ===========================================================================

/**
 * @brief Поиск веса биграммы в английской таблице
 * @param first Первый символ биграммы (lowercase ASCII)
 * @param second Второй символ биграммы (lowercase ASCII)
 * @return Вес биграммы или 0 если не найдена
 */
[[nodiscard]] inline std::uint8_t lookup_en_bigram(char first,
                                                   char second) noexcept {
#if defined(__x86_64__) && !defined(PUNTO_NO_ASM) && defined(__AVX2__)
  return asm_utils::avx2_find_bigram(kEnBigrams.data(), kEnBigrams.size(), first,
                                     second);
#elif defined(__x86_64__) && !defined(PUNTO_NO_ASM)
  return asm_utils::sse_find_bigram(kEnBigrams.data(), kEnBigrams.size(), first,
                                    second);
#else
  for (const auto &entry : kEnBigrams) {
    if (entry.first == first && entry.second == second) {
      return entry.weight;
    }
  }
  return 0;
#endif
}

/**
 * @brief Поиск веса биграммы в русской таблице
 * @param first Первый символ биграммы (латинский эквивалент, lowercase)
 * @param second Второй символ биграммы (латинский эквивалент, lowercase)
 * @return Вес биграммы или 0 если не найдена
 */
[[nodiscard]] inline std::uint8_t lookup_ru_bigram(char first,
                                                   char second) noexcept {
#if defined(__x86_64__) && !defined(PUNTO_NO_ASM) && defined(__AVX2__)
  return asm_utils::avx2_find_bigram(kRuBigrams.data(), kRuBigrams.size(), first,
                                     second);
#elif defined(__x86_64__) && !defined(PUNTO_NO_ASM)
  return asm_utils::sse_find_bigram(kRuBigrams.data(), kRuBigrams.size(), first,
                                    second);
#else
  for (const auto &entry : kRuBigrams) {
    if (entry.first == first && entry.second == second) {
      return entry.weight;
    }
  }
  return 0;
#endif
}

// ===========================================================================
// Невозможные сочетания (для штрафов)
// ===========================================================================

/// Проверяет, является ли биграмма "невозможной" для русского языка
/// Например, 4+ согласных подряд, мягкий знак в начале, и т.д.
[[nodiscard]] constexpr bool is_invalid_ru_bigram(char first,
                                                  char second) noexcept {
  // Мягкий/твёрдый знак в начале слова (в QWERTY: m и ])
  if (first == 'm' || first == ']') {
    return true;
  }

  // Сочетания, которые действительно почти невозможны:
  // ь/ъ перед согласными (большинство), ы перед гласными и т.д.
  // Но для простоты и точности лучше убрать лишние штрафы,
  // так как n-граммы и так дадут низкий скор для странных сочетаний.

  return false;
}

/// Проверяет, является ли биграмма "невозможной" для английского языка
[[nodiscard]] constexpr bool is_invalid_en_bigram(char first,
                                                  char second) noexcept {
  // В английском редко встречаются:
  // Двойные буквы кроме ll, ss, ee, oo, ff, tt, rr, nn, pp, mm
  if (first == second) {
    if (first != 'l' && first != 's' && first != 'e' && first != 'o' &&
        first != 'f' && first != 't' && first != 'r' && first != 'n' &&
        first != 'p' && first != 'm') {
      return true; // Редкая двойная буква
    }
  }

  // Некоторые невозможные начала
  // bx, cx, dx, fx, gx, hx, jx, kx, lx, mx, nx, px, qx, rx, sx, tx, vx, wx, zx
  if (second == 'x' && first != 'e' && first != 'a' && first != 'o' &&
      first != 'i' && first != 'u') {
    return true;
  }

  return false;
}

// ===========================================================================
// Триграммы (для повышения точности на словах 3+ символов)
// ===========================================================================

/// Структура для хранения триграммы и её веса
struct TrigramEntry {
  char first;
  char second;
  char third;
  std::uint8_t weight;
};

// Топ-64 триграммы английского языка
// clang-format off
inline constexpr std::array<TrigramEntry, 64> kEnTrigrams = {{
    {'t', 'h', 'e', 255}, // the
    {'a', 'n', 'd', 250}, // and
    {'i', 'n', 'g', 245}, // ing
    {'t', 'i', 'o', 240}, // tio
    {'i', 'o', 'n', 235}, // ion
    {'e', 'n', 't', 230}, // ent
    {'e', 'r', 'e', 225}, // ere
    {'h', 'e', 'r', 220}, // her
    {'a', 't', 'i', 215}, // ati
    {'f', 'o', 'r', 210}, // for
    {'t', 'e', 'r', 205}, // ter
    {'h', 'a', 't', 200}, // hat
    {'t', 'h', 'a', 195}, // tha
    {'e', 'r', 's', 190}, // ers
    {'h', 'i', 's', 185}, // his
    {'r', 'e', 's', 180}, // res
    {'i', 'l', 'l', 175}, // ill
    {'a', 'l', 'l', 170}, // all
    {'n', 'c', 'e', 165}, // nce
    {'m', 'e', 'n', 160}, // men
    {'i', 't', 'h', 155}, // ith
    {'o', 'u', 't', 150}, // out
    {'e', 's', 't', 145}, // est
    {'a', 'n', 't', 140}, // ant
    {'t', 'e', 'd', 135}, // ted
    {'o', 'u', 'r', 130}, // our
    {'e', 'a', 's', 125}, // eas
    {'e', 'a', 'r', 120}, // ear
    {'o', 'n', 'e', 115}, // one
    {'e', 'v', 'e', 110}, // eve
    {'v', 'e', 'r', 105}, // ver
    {'a', 'r', 'e', 100}, // are
    {'n', 'o', 't', 95},  // not
    {'o', 'r', 'e', 90},  // ore
    {'a', 'v', 'e', 85},  // ave
    {'c', 'o', 'm', 80},  // com
    {'p', 'r', 'o', 75},  // pro
    {'t', 'r', 'a', 70},  // tra
    {'a', 'b', 'l', 65},  // abl
    {'b', 'l', 'e', 60},  // ble
    {'c', 'o', 'n', 55},  // con
    {'i', 'n', 't', 50},  // int
    {'n', 'e', 'w', 45},  // new
    {'o', 'w', 'n', 40},  // own
    {'s', 'i', 'o', 35},  // sio
    {'t', 'r', 'e', 30},  // tre
    {'i', 'c', 'a', 25},  // ica
    {'e', 'r', 'a', 20},  // era
    {'r', 'o', 'u', 15},  // rou
    {'t', 'o', 'n', 12},  // ton
    {'s', 't', 'a', 10},  // sta
    {'s', 't', 'e', 8},   // ste
    {'a', 'c', 'k', 6},   // ack
    {'a', 'c', 't', 5},   // act
    {'l', 'l', 'y', 4},   // lly
    {'e', 'l', 'y', 3},   // ely
    {'f', 'u', 'l', 2},   // ful
    {'e', 's', 's', 1},   // ess
    // Заполнители
    {0, 0, 0, 0}, {0, 0, 0, 0}, {0, 0, 0, 0}, {0, 0, 0, 0}, {0, 0, 0, 0}, {0, 0, 0, 0},
}};

// Топ-64 триграммы русского языка (в QWERTY кодировке)
inline constexpr std::array<TrigramEntry, 64> kRuTrigrams = {{
    // про -> ghj, сто -> cnj, ени -> tyb, ост -> jcn, ние -> ybt
    {'g', 'h', 'j', 255}, // про
    {'c', 'n', 'j', 250}, // сто
    {'t', 'y', 'b', 245}, // ени
    {'j', 'c', 'n', 240}, // ост
    {'y', 'b', 't', 235}, // ние
    {'n', 'j', 'h', 230}, // тор
    {'y', 'f', '.', 225}, // наю (на+ю = yf.)
    {'g', 'j', 'k', 220}, // пол
    {'g', 'h', 'b', 215}, // при
    {'b', 'n', 'm', 210}, // ить
    {'r', 'j', 'n', 205}, // кот
    {'j', 'd', 'f', 200}, // ова
    {'n', 't', 'k', 195}, // тел
    {'t', 'k', 'm', 190}, // ель
    {'c', 'n', 'b', 185}, // сти
    {'j', 'h', 'j', 180}, // оро
    {'h', 'j', 'd', 175}, // ров
    {'y', 'j', 'd', 170}, // нов
    {'t', 'h', 'f', 165}, // ера
    {'k', 't', 'y', 160}, // лен
    {'y', 't', 'y', 155}, // нен
    {'g', 'j', 'l', 150}, // под
    {'d', 'j', ',', 145}, // воб -> vj,
    {'d', 'j', 'k', 140}, // вол
    {'k', 'b', 'n', 135}, // лит
    {'h', 't', 'l', 130}, // ред
    {'l', 't', 'k', 125}, // дел
    {'j', 'l', 'y', 120}, // одн
    {'l', 'y', 'j', 115}, // дно
    {'v', 'j', ',', 110}, // моб
    {'j', 'y', 'b', 105}, // они
    {'t', 'n', 'j', 100}, // ето
    {'g', 'j', 'd', 95},  // пов
    {'j', 'd', 'j', 90},  // ово
    {'g', 'h', 't', 85},  // пре
    {'y', 'j', 'c', 80},  // нос
    {'r', 'f', 'r', 75},  // как
    {'n', 'f', 'r', 70},  // так
    {'f', 'r', 'j', 65},  // ако
    {'j', 'l', 'f', 60},  // ода
    {'l', 'f', 'y', 55},  // дан
    {'f', 'y', 'y', 50},  // анн
    {'y', 'y', 'j', 45},  // нно
    {'t', 'c', 'n', 40},  // ест
    {'c', 'n', 'f', 35},  // ста
    {'n', 'f', 'k', 30},  // тал
    {'f', 'k', 'm', 25},  // аль
    {'c', 'r', 'j', 20},  // ско
    {'j', 'q', '.', 15},  // ой+ю = jq.
    {'t', 'q', 'c', 12},  // ейс
    {'q', 'c', 'z', 10},  // йся
    {'n', 'm', 'c', 8},   // тьс
    {'m', 'c', 'z', 6},   // ься
    {'c', 'z', '.', 5},   // ся+ю
    // Заполнители
    {0, 0, 0, 0}, {0, 0, 0, 0}, {0, 0, 0, 0}, {0, 0, 0, 0}, {0, 0, 0, 0},
    {0, 0, 0, 0}, {0, 0, 0, 0}, {0, 0, 0, 0}, {0, 0, 0, 0}, {0, 0, 0, 0},
}};
// clang-format on

/**
 * @brief Поиск веса триграммы в английской таблице
 */
[[nodiscard]] constexpr std::uint8_t lookup_en_trigram(char first, char second,
                                                       char third) noexcept {
  for (const auto &entry : kEnTrigrams) {
    if (entry.first == first && entry.second == second &&
        entry.third == third) {
      return entry.weight;
    }
  }
  return 0;
}

/**
 * @brief Поиск веса триграммы в русской таблице
 */
[[nodiscard]] constexpr std::uint8_t lookup_ru_trigram(char first, char second,
                                                       char third) noexcept {
  for (const auto &entry : kRuTrigrams) {
    if (entry.first == first && entry.second == second &&
        entry.third == third) {
      return entry.weight;
    }
  }
  return 0;
}

} // namespace punto
