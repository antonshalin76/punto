# Punto Switcher для Linux (C-версия)

Легковесная реализация Punto Switcher на C для Linux с использованием Interception Tools.
Позволяет исправлять текст, набранный в неправильной раскладке клавиатуры.

## Возможности

- **Ручная инверсия слова (Pause)**: Исправление последнего набранного слова с сохранением регистра
- **Инверсия регистра слова (Ctrl+Pause)**: Смена регистра символов последнего слова (например, "пРИВЕТ" -> "Привет")
- **Инверсия выделенного текста (Shift+Pause)**: Исправление раскладки любого выделенного фрагмента текста
- **Инверсия регистра выделения (Alt+Pause)**: Смена регистра для выделенного фрагмента текста
- **Транслитерация (LCtrl+LAlt+Pause)**: Преобразование выделенного текста (Кириллица <-> Латиница)
- **Повторная инверсия (Pause)**: Многократное нажатие Pause переключает слово туда-обратно
- **Поддержка системных хоткеев**: Ctrl, Alt, Meta комбинации работают без помех
- **Минимальное потребление ресурсов**: Ядро перехватчика написано на чистом C

## Требования

### Системные зависимости

#### Ubuntu/Debian

```bash
# Сборка
sudo apt install build-essential cmake

# Interception Tools (ядро системы)
sudo apt install interception-tools

# Инструменты для работы с буфером обмена и X11
sudo apt install xclip xsel xdotool x11-utils

# Python 3 (для скрипта инверсии выделенного текста)
sudo apt install python3
```

#### Arch Linux

```bash
sudo pacman -S base-devel cmake interception-tools xclip xsel xdotool xorg-xprop python
```

#### Fedora

```bash
sudo dnf install gcc make cmake interception-tools xclip xsel xdotool xprop python3
```

### Назначение зависимостей

| Пакет                | Назначение                                                                  |
| ------------------------- | ------------------------------------------------------------------------------------- |
| `build-essential`       | Компилятор GCC и make                                                      |
| `interception-tools`    | Перехват и эмуляция клавиатурных событий          |
| `xclip`                 | Работа с буфером обмена X11                                       |
| `xsel`                  | Работа с буфером обмена X11 (альтернатива)            |
| `xdotool`               | Эмуляция нажатий клавиш в X11                                   |
| `x11-utils` (`xprop`) | Определение активного окна                                    |
| `python3`               | Для скриптов `punto-invert`, `punto-case-invert` и `punto-translit` |

### Сборка Interception Tools из исходников

Если `interception-tools` недоступен в репозиториях:

```bash
git clone https://gitlab.com/interception/linux/tools.git interception-tools
cd interception-tools
cmake -B build -DCMAKE_BUILD_TYPE=Release
cmake --build build
sudo cmake --install build
```

## Установка

### Способ 1: Установка deb-пакета (рекомендуется)

```bash
# Скачайте или соберите пакет
git clone https://github.com/antonshalin76/punto.git
sudo apt install ./punto-ubuntu.deb
```

Пакет автоматически:

- Установит все зависимости
- Скопирует бинарники в `/usr/local/bin/`
- Создаст конфигурации в `/etc/punto/` и `/etc/interception/`
- Включит и запустит сервис `udevmon`

### Способ 2: Сборка deb-пакета из исходников

```bash
git clone https://github.com/antonshalin76/punto.git
./build-deb.sh
sudo apt install ./punto-ubuntu.deb
```

### Способ 3: Ручная установка

```bash
make clean && make
sudo make install
```

### Настройка udevmon

Создайте файл конфигурации `/etc/interception/udevmon.yaml`:

```yaml
- JOB: "intercept -g $DEVNODE | punto | uinput -d $DEVNODE"
  DEVICE:
    EVENTS:
      EV_KEY: [KEY_A, KEY_B, KEY_C, KEY_D, KEY_E, KEY_F, KEY_G, KEY_H, KEY_I, KEY_J, KEY_K, KEY_L, KEY_M, KEY_N, KEY_O, KEY_P, KEY_Q, KEY_R, KEY_S, KEY_T, KEY_U, KEY_V, KEY_W, KEY_X, KEY_Y, KEY_Z, KEY_SPACE, KEY_ENTER, KEY_TAB, KEY_BACKSPACE, KEY_PAUSE, KEY_DOT, KEY_COMMA, KEY_LEFTSHIFT, KEY_RIGHTSHIFT, KEY_LEFTCTRL, KEY_RIGHTCTRL, KEY_LEFTALT, KEY_RIGHTALT, KEY_LEFTMETA, KEY_RIGHTMETA, KEY_GRAVE]
```

### Запуск сервиса

```bash
sudo systemctl enable udevmon
sudo systemctl start udevmon
```

## Использование

### Горячие клавиши

| Комбинация               | Действие                                                                               |
| ---------------------------------- | ---------------------------------------------------------------------------------------------- |
| **Pause**                    | Инвертировать раскладку текущего/последнего слова |
| **Pause** (повторно) | Инвертировать обратно (toggle)                                             |
| **Shift+Pause**              | Инвертировать раскладку выделенного текста              |
| **Ctrl+Pause**               | Инвертировать регистр последнего слова                      |
| **Alt+Pause**                | Инвертировать регистр выделенного текста                  |
| **LCtrl+LAlt+Pause**         | Транслитерировать выделенный текст (Кир <-> Лат)         |

### Примеры

#### Инверсия слова

1. Набираете: `ghbdtn` (вместо "привет")
2. Нажимаете: **Pause**
3. Результат: `привет`

#### Инверсия с сохранением регистра

1. Набираете: `GhBdTn`
2. Нажимаете: **Pause**
3. Результат: `ПрИвЕт`

#### Инверсия выделенного текста

1. Набираете: `Yfgbitv ldf ckjdf`
2. Выделяете текст (Ctrl+A или мышью)
3. Нажимаете: **Shift+Pause**
4. Результат: `Напишем два слова`

#### Инверсия регистра (Case Swap)

1. Набираете: `пРИВЕТ`
2. Нажимаете: **Ctrl+Pause**
3. Результат: `Привет`
4. Выделяете `Hello World`, нажимаете **Alt+Pause** -> `hELLO wORLD`

#### Транслитерация

1. Выделяете: `Привет`
2. Нажимаете: **LCtrl + LAlt + Pause**
3. Результат: `Privet`
4. Выделяете `Shchuka`, нажимаете ту же комбинацию -> `Щука`

## Архитектура

```
┌─────────────────────────────────────────────────────────────┐
│                         udevmon                             │
│  (запускает pipeline для каждой клавиатуры)                 │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  intercept -g $DEVNODE                                      │
│  (перехватывает события клавиатуры)                         │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  punto (C)                                                  │
│  • Буферизирует набранные символы                           │
│  • Отслеживает модификаторы (Shift, Ctrl, Alt, Meta)        │
│  • Обрабатывает Pause/Shift+Pause/Ctrl+Pause/Alt+Pause      │
│  • Вызывает punto-switch для переключения раскладки         │
│  • Вызывает punto-invert для инверсии раскладки текста      │
│  • Вызывает punto-case-invert для инверсии регистра текста  │
│  • Вызывает punto-translit для транслитерации текста        │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  uinput -d $DEVNODE                                         │
│  (эмулирует нажатия клавиш)                                 │
└─────────────────────────────────────────────────────────────┘
```

### Компоненты

| Файл              | Назначение                                                                    |
| --------------------- | --------------------------------------------------------------------------------------- |
| `src/punto.c`       | Основная логика обработки клавиш                           |
| `punto-switch`      | Bash-скрипт переключения раскладки через IBus/GSettings |
| `punto-invert`      | Python-скрипт инверсии раскладки текста                    |
| `punto-case-invert` | Python-скрипт инверсии регистра текста                      |
| `punto-translit`    | Python-скрипт транслитерации текста                           |
| `udevmon.yaml`      | Конфигурация для udevmon                                                 |
| `Makefile`          | Сборка и установка                                                      |

## Настройка

Конфигурационный файл: `/etc/punto/config.yaml`

```yaml
# Punto Switcher Configuration

# Хоткей переключения раскладки
hotkey:
  modifier: leftctrl    # leftctrl, rightctrl, leftalt, rightalt, leftshift, rightshift
  key: grave            # grave (` ~), space, tab, backslash, capslock

# Задержки (в миллисекундах)
delays:
  key_press: 20         # Задержка между нажатием и отпусканием клавиши
  layout_switch: 100    # Задержка после переключения раскладки
  retype: 3             # Задержка между символами при перепечатывании
```

### Доступные клавиши

| Имя                        | Клавиша |
| ----------------------------- | -------------- |
| `leftctrl`, `rightctrl`   | Ctrl           |
| `leftalt`, `rightalt`     | Alt            |
| `leftshift`, `rightshift` | Shift          |
| `leftmeta`, `rightmeta`   | Super/Win      |
| `grave`                     | \` ~           |
| `space`                     | Пробел   |
| `tab`                       | Tab            |
| `backslash`                 | \\             |
| `capslock`                  | Caps Lock      |

После изменения конфига перезапустите сервис:

```bash
sudo systemctl restart udevmon
```

## Удаление

### Если установлен через deb-пакет

```bash
sudo apt remove punto-switcher
```

Для полного удаления вместе с конфигурацией:

```bash
sudo apt purge punto-switcher
sudo rm -rf /etc/punto
```

### Если установлен вручную (make install)

```bash
sudo make uninstall
sudo systemctl stop udevmon
sudo systemctl disable udevmon
sudo rm -rf /etc/punto
```

## Решение проблем

### Проверка работы сервиса

```bash
sudo systemctl status udevmon
sudo journalctl -u udevmon -f
```

### Клавиатура не работает после установки

```bash
sudo systemctl stop udevmon
```

### Инверсия выделенного текста не работает

Убедитесь, что установлены зависимости:

```bash
sudo apt install xclip xsel xdotool
```

### Переключение раскладки не работает

Проверьте, что ваш хоткей переключения раскладки соответствует
настроенному в `/etc/punto/config.yaml`.

## История изменений

### v1.0.3

- **Транслитерация (Cyrillic <-> Latin)**: Добавлена новая функция по комбинации **LCtrl + LAlt + Pause**.
  - Автоматическое определение направления (если кириллицы > 50% -> в латиницу, иначе -> в кириллицу).
  - Умная обработка диграфов (shch -> щ, zh -> ж и т.д.).
- **Приоритезация комбинаций**: Исправлена логика перехвата горячих клавиш, предотвращающая ложные срабатывания при использовании нескольких модификаторов.

### v1.0.2

- **Инверсия регистра (Case Swap)**: Добавлена возможность инвертировать регистр букв.
  - **Ctrl+Pause**: Инверсия последнего набранного слова (без смены раскладки).
  - **Alt+Pause**: Инверсия выделенного текста.
- **Умное управление модификаторами**: Исправлена ошибка, при которой зажатые Ctrl/Alt мешали корректному стиранию (Backspace) и перепечатыванию текста.
- **Рефакторинг буфера**: Модификаторы больше не сбрасывают буфер набранного слова мгновенно, позволяя использовать сложные комбинации клавиш.

### v1.0.1

- **Исправлена инверсия слова с пробелами**: Теперь при нажатии `Pause` слово корректно исправляется, даже если после него нажат один или несколько пробелов/табов.
- **Восстановление отступов**: После инверсии слова все последующие пробелы и табуляции сохраняются.
- **Безопасный сброс**: Нажатие `Enter` или навигационных клавиш (стрелки) теперь корректно сбрасывает историю набора, предотвращая ошибочные срабатывания.
- **Исправлен скрипт сборки**: Устранены ошибки путей в `build-deb.sh`.

### v1.0.0

- Первая публичная версия C-реализации.
- Поддержка `Pause` для слова и `Shift+Pause` для выделения.

## Лицензия

MIT License

## Автор

Anton Shalin <anton.shalin@gmail.com>
